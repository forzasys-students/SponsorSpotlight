<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Processing - SponsorSpotlight</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body class="d-flex flex-column min-vh-100">
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">SponsorSpotlight</a>
        </div>
    </nav>

    <main class="flex-grow-1 d-flex align-items-center justify-content-center">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h2 class="mb-0">Processing {{ file_type }}</h2>
                        </div>
                        <div class="card-body">
                            <div id="processing-status">
                                <p class="lead text-center mb-3" id="status-message">Initializing...</p>
                                
                                <div class="progress mb-3">
                                    <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
                                         role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                                
                                <div id="frame-info" class="text-center text-muted mb-3">
                                    <span id="current-frame">0</span> / <span id="total-frames">0</span> frames processed
                                </div>
                                
                                <div id="time-info" class="text-center text-muted">
                                    Processing time (AI detection): <span id="elapsed-time">00:00</span>
                                </div>
                                <div id="gpu-info" class="text-center text-muted mt-1" style="display:none;">
                                    Peak GPU used: <span id="gpu-peak">0</span> MB
                                </div>
                            </div>
                            
                            <div id="error-container" class="alert alert-danger d-none mt-3">
                                <h4>Error</h4>
                                <p id="error-message"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-dark text-white mt-5 py-3">
        <div class="container text-center">
            <p class="mb-0">&copy; 2025 SponsorSpotlight</p>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const progressBar = document.getElementById('progress-bar');
            const statusMessage = document.getElementById('status-message');
            const currentFrame = document.getElementById('current-frame');
            const totalFrames = document.getElementById('total-frames');
            const elapsedTime = document.getElementById('elapsed-time');
            const errorContainer = document.getElementById('error-container');
            const errorMessage = document.getElementById('error-message');
            const frameInfo = document.getElementById('frame-info');
            const gpuInfo = document.getElementById('gpu-info');
            const gpuPeak = document.getElementById('gpu-peak');
            
            // For image processing, hide the frame info
            if ('{{ file_type }}' === 'image') {
                frameInfo.style.display = 'none';
            }
            
            // Function to format time as MM:SS
            function formatTime(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }
            
            // Function to check progress
            function checkProgress() {
                fetch('/progress')
                    .then(response => response.json())
                    .then(data => {
                        // Update progress bar
                        const percentage = data.progress_percentage || 0;
                        progressBar.style.width = `${percentage}%`;
                        progressBar.setAttribute('aria-valuenow', percentage);

                        // Update progress bar color based on stage
                        const stageClass = `stage-${data.stage.toLowerCase()}`;
                        progressBar.className = 'progress-bar progress-bar-striped progress-bar-animated'; // Reset classes
                        progressBar.classList.add(stageClass);
                        
                        // Update status message
                        statusMessage.textContent = data.message || 'Processing...';
                        
                        // Update frame info if available
                        if (data.current_frame && data.total_frames) {
                            currentFrame.textContent = data.current_frame;
                            totalFrames.textContent = data.total_frames;
                        }
                        
                        // Update elapsed time
                        if (data.elapsed_time) {
                            elapsedTime.textContent = formatTime(data.elapsed_time);
                        }

                        // Update GPU peak usage if available
                        if (data.gpu_peak_mb !== undefined && data.gpu_peak_mb !== null) {
                            gpuInfo.style.display = 'block';
                            gpuPeak.textContent = Math.round(data.gpu_peak_mb);
                        }
                        
                        // Check for completion or error
                        if (data.stage === 'COMPLETE') {
                            // Redirect to results page
                            window.location.href = `/results/{{ session.file_info.hash }}`;
                        } else if (data.stage === 'ERROR') {
                            // Show error message
                            errorContainer.classList.remove('d-none');
                            errorMessage.textContent = data.message;
                        } else {
                            // Continue checking progress
                            setTimeout(checkProgress, 1000);
                        }
                    })
                    .catch(error => {
                        console.error('Error checking progress:', error);
                        errorContainer.classList.remove('d-none');
                        errorMessage.textContent = 'Failed to update progress. Please refresh the page.';
                    });
            }
            
            // Start checking progress
            checkProgress();
        });
    </script>
</body>
</html>